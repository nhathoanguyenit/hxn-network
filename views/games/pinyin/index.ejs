<h2>ðŸŽ® Pinyin Game Demo</h2>
<p>Use <b>WASD</b> or arrow keys to move, <b>Space</b> to drop bomb</p>
<div class="d-flex w-100">
  <div id="game"></div>
</div>
  <button id="respawnBtn" class="btn btn-primary" style="display:none;">Respawn</button>
<style>
  #game {
    margin: 20px auto;
    display: grid;
    grid-template-columns: repeat(50, 5px);
    grid-template-rows: repeat(50, 5px);
    gap: 2px;
  }

  .cell {
    width: 5px;
    height: 5px;
    background: #eee;
    border-radius:1px;
    box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.2);
    transition: background 0.2s;
  }

  .player {
    background: #3498db;
  }

  .self {
    background: #2ecc71;
  }

  .dead {
    background: #555;
    opacity: 0.6;
  }

  .bomb {
    background: #e74c3c;
    animation: blink 0.3s infinite alternate;
  }

  .explosion {
    background: orange;
    animation: explode 0.4s ease-out forwards;
  }

  .range {
    background: rgba(255, 165, 0, 0.4);
  }

  @keyframes blink {
    from {
      opacity: 1;
    }

    to {
      opacity: 0.6;
    }
  }

  @keyframes explode {
    0% {
      opacity: 1;
      transform: scale(1);
    }

    100% {
      opacity: 0;
      transform: scale(1.6);
    }
  }
</style>

<script>
  (() => {
    const socket = io('/pinyin', {
      withCredentials: true,
      query: {
        room: 'default'
      }
    });

    const respawnBtn = document.getElementById('respawnBtn');
    const gameEl = document.getElementById('game');
    const gridSize = 50;
    let players = [];
    let bombs = [];
    let explosionCells = []; // temporary highlight

    function render() {
      gameEl.innerHTML = '';
      let me = null;
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const cell = document.createElement('div');
          cell.classList.add('cell');

          const player = players.find(p => p.x === x && p.y === y);
          const bomb = bombs.find(b => b.x === x && b.y === y);

          if (bomb) cell.classList.add('bomb');
          if (player) {
            if (!player.alive) cell.classList.add('dead');
            else cell.classList.add(player.isSelf ? 'self' : 'player');
            if (player.isSelf) me = player;
          }

          gameEl.appendChild(cell);
        }
      }
      if (me && !me.alive) respawnBtn.style.display = 'inline';
      else respawnBtn.style.display = 'none';
    }

    socket.on('connect', () => console.log('âœ… Connected to game server'));

    socket.on('players', (list) => {
      players = list.map(p => ({
        ...p,
        isSelf: p.id === socket.id
      }));
      render();
    });

    socket.on('bombDropped', (bomb) => {
      bombs.push(bomb);
      render();
    });

    // Show explosion + range
    socket.on('bombExploded', (bomb) => {
      const radius = 1; // must match server radius
      const affected = [];

      // Cross shape range: center + up/down/left/right
      affected.push({
        x: bomb.x,
        y: bomb.y
      });
      for (let i = 1; i <= radius; i++) {
        if (bomb.x + i < gridSize) affected.push({
          x: bomb.x + i,
          y: bomb.y
        });
        if (bomb.x - i >= 0) affected.push({
          x: bomb.x - i,
          y: bomb.y
        });
        if (bomb.y + i < gridSize) affected.push({
          x: bomb.x,
          y: bomb.y + i
        });
        if (bomb.y - i >= 0) affected.push({
          x: bomb.x,
          y: bomb.y - i
        });
      }

      explosionCells = affected;

      render();

      const index = bomb.y * gridSize + bomb.x;
      const cell = gameEl.children[index];
      if (cell) {
        cell.classList.remove('bomb');
        cell.classList.add('explosion');
        console.log(cell.classList)
      }

      setTimeout(() => {
        explosionCells = [];
        bombs = bombs.filter(b => b.id !== bomb.id);
        render();
      }, 600);
    });


    respawnBtn.addEventListener('click', () => {
      socket.emit('respawn');
    });
    // Movement controls
    document.addEventListener('keydown', (e) => {
      const me = players.find(p => p.isSelf);
      if (!me || !me.alive) return; // DEAD players cannot move or drop bombs

      if (e.code === 'Space') {
        socket.emit('dropBomb');
        return;
      }

      const keyMap = {
        ArrowUp: 38,
        ArrowDown: 40,
        ArrowLeft: 37,
        ArrowRight: 39,
        w: 38,
        s: 40,
        a: 37,
        d: 39
      };
      const key = keyMap[e.key];
      if (!key) return;

      socket.emit('move', {
        key
      });
    });
  })()
</script>